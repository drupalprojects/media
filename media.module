<?php

// $Id$


/* ***************************************** */
/* DEFINITIONS                               */
/* ***************************************** */

define('MEDIA_RESOURCE_URI_DEFAULT', 'public://');
define('MEDIA_TYPES_DEFAULT', '*');

/* ***************************************** */
/* DRUPAL API FUNCTIONS                      */
/* ***************************************** */


/**
 * Implementation of hook_menu.
 * 
 */
function media_menu() {
  // ajax formatter 
  $items['media/ahah'] = array(
    'page callback' => 'media_ahah_formatter_load',
    'access arguments' => array('access content'),
    'file' => 'media_ahah.inc',
  );
  
  // media configuration per content type
  $items['admin/content/media'] = array(
    'title' => 'Media',
    'description' => 'Configure your site\'s Media settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_admin_settings'),
    'access arguments' => array('administer media'),
    'file' => 'media_admin.inc',
    'type' => MENU_SUGGESTED_ITEM,
  );
  
  // build pages for each content type
  $content_types = node_get_types();
  if ($content_types) {
    foreach ($content_types as $content_type) {
      $items['admin/content/media/'. $content_type->type] = array(
        'title' => $content_type->name,
        'description' => 'Configure Media settings for '. $content_type->name,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('media_admin_settings', $content_type->type),
        'access arguments' => array('administer media'),
        'file' => 'media_admin.inc',
        'type' => MENU_SUGGESTED_ITEM,
      );
    }
  }
  
  return $items;
}


/**
 * Implementation of hook_form_alter
 * @param $form
 * @param $form_state
 * @param $form_id
 * 
 */
function media_form_alter (&$form, $form_state, $form_id) {
  global $user;
  
  // add the media browser on the node add/edit screen
  if (strstr($form_id, 'node_form') ) {
    // is the media browser enabled on this node type?
    if (variable_get('media_'. $form['type']['#value'] .'_enabled', null)) {
      // get the fields we need to enable on this module
      $fields = media_active_fields_for_node_type($form['type']['#value']);
      foreach ($fields as $field => $resources) {
        $form[$field]['media'] = media_build_browser($resources, $form['type']['#value'], $field, $user->uid);
        $form[$field][0]['#attributes'] = array('class' => 'media replace');        
      }
    }    
  }
}


/**
 * Register theming functions
 * @return array
 */
function media_theme() {
  return array(
    'media_no_tabs_display' => array(
      'file' => 'media_theme.inc',
      'arguments' => array(
        'tabs' => NULL,
      ),
    ),
    'media_file_browser' => array(
      'file' => 'media_theme.inc',
      'arguments' => array('element' => null),
    )
  );
}


/* ***************************************** */
/* media hook calls                          */
/* ***************************************** */

/**
 * Gets all of the modules which register with Media
 * @param array $ids
 *   only return the specified ids
 * @return array 
 *   of registrations 
 */
function media_get_registered_modules($ids = null) {
  static $registrations;
  // only build cache if ids are not being 
  // passed in
  if (! $registrations ) {
    $registrations = array();
    // get all the modules which implement 
    foreach (module_implements('media_register') as $module) {
      $function = $module .'_media_register';
      // get all the registrations
      $registration = $function();
      // add the module name to each registration
      foreach (array_keys($function()) as $key) {
        $registration[$key]['module'] = $module;
        if (! $registraton[$key]['uri']) {
          $registration[$key]['uri'] = MEDIA_RESOURCE_URI_DEFAULT;
        }
        if (! $registration[$key]['types']) {
          $registration[$key]['types'] = MEDIA_TYPES_DEFAULT;
        }
      }
      $registrations = array_merge($registrations, $registration); 
    }            
  }
  // return requested registrations
  if ($ids) {
    foreach ($ids as $id) {
      $return[$id] = $registrations[$id];
    }
    return $return;
  }
  return $registrations;  
}


/**
 * Select registrations for use by matching against uri and file extension
 *
 * @param array $registrations
 *   array of extensions
 * @param string $uri
 *   the kind of uri being used
 * @param string $file_extension
 *   the current file extension
 * @return array
 *   of applicable formatters
 */
function media_get_applicable_formatters($registrations, $file_extension) {
  // do we have a file extension? 
  if ($file_extension) {
    foreach ($registrations as $id => $formatter) {
      // does this formatter use any file type?
      if (! $registration['types'] == MEDIA_TYPES_DEFAULT ) {
        // we need to look and see if this file type is supported specifically
        if (! in_array($file_extension, $registration['types'])) {
          // this registration is not useful
          unset($registrations[$id]);          
        }         
      }
    }
  }
  return $registrations;
}


/**
 * Get all module data that uses the "media_user_files_select" hook
 * @TODO clean this form up and use a form theme function
 * @param array $resources
 *   array of resource functions to call
 * @param string $node_type
 * @param string $field
 * @param uid $uid
 * @return array
 *   drupal form array
 */
function media_build_browser($resources, $node_type, $field, $uid) {
  $items = array();
  $form = array();
    
  // get all the resources 
  $resources = media_get_resources($resources, $node_type, $field, $uid);

  // now we order modules into tabs structure
  // @TODO implement admin weighting here somehow
  // @TODO clean this crap up! 
  // split the tabs into sets of drawers
  foreach ($resources as $tab_name => $drawer_items) {   
    $first = true;
    $drawers = array();
    // now create the sub element (drawer)
    foreach ($drawer_items as $drawer_name => $form ) {
      // strip out any scary stuff so we can make an id
      $drawer_id = media_create_drawer_id($drawer_name);
      // create the drawer entry
      $drawers[] = '<a onclick="javascript: return false;" href="#'. $drawer_id .'">'. $drawer_name .'</a>';
      
      // add a add buton on each item
      // @TODO this needs AHAH support
      $form[$drawer_id]['form']['add'] = array(
        '#type' => 'button',
        '#value' => t('Add'),
        '#ahah' => array(
          'event' => 'click',
          'path' => 'media/ahah/'. $form['resource_id'] .'/'. $node_type .'/'. $field,
          'wrapper' => $drawer_id .'_add',
          'method' => 'replace',        
        ),
        '#suffix' => '<div id="'. $drawer_id .'_add"></div>',
      );
      // remove the resource id
      unset($form['resource_id']);
      $my_files_elements[$tab_name][$drawer_id] = array(
        '#type' => 'markup',
        '#value' => '',
        '#prefix' => '<div class="media browser display '. ($first ? 'first': '') .'" id="'. $drawer_id .'"><a name="'. $drawer_id .'"/>',
        '#suffix' => '</div>',
        'content' => $form,
      );
      $first = false;
    }
    // now add the drawers onto the tab and make it render first
    $my_files_elements[$tab_name]['drawers']['#value'] = '<div class="drawers">'. theme('item_list', $drawers) .'</div>';
    $my_files_elements[$tab_name]['drawers']['#weight'] = -9;
  }

  return media_tabs_form($my_files_elements);
  
}


/**
 * Generic hook call for media
 *
 * @param string $hook
 *   hook name
 * @return array
 */
function media_extend($hook) {
  $data = array();
  // get a list of the modules that implement this hook
  foreach (module_implements($hook) as $module) {
    // add the data keyed by module name
    $data[$module] = module_invoke($module, $hook);
  }
  if (count($data)) {return $data; }
}


/**
 * This handles all the admin hooks that do not
 * require the passing of a file object. This does not use
 * module_invoke_all() so that the array of data can be 
 * keyed by the module name for ease of usage later
 * @param string $hook
 *  name of the hook being called
 * @return array
 *  array of data from each module that implements the hook
 */
function media_admin_extend($hook) {
  $data = array();
  // get a list of the modules that implement this hook
  foreach (module_implements($hook) as $module) {
    // add the data keyed by module name
    $data[$module] = module_invoke($module, $hook);
  }
  if (count($data)) {return $data; }
}


/**
 * This allows admins to to configure specific settings
 * per module for media.
 * @return array
 *   drupal form array
 */
function media_admin_module_options_settings_form() {
  if (! $options = media_admin_extend('media_admin_options_settings')) {
    drupal_set_message(t('Sorry, there are no modules which have configurable settings.'));
    return;
  }
  // build a fieldset per module
  foreach ($options as $module_name => $option) {
    $form[$module_name] = array(
      '#type' => 'fieldset',
      '#title' => $module_name
    );
    $form[$module_name][] = $options;
  }
  return $form;
}


/**
 * This takes all of the modules that implement the media permissions 
 * hook, gets them on a page, and adds a roll setting to control access
 * @return array
 *  drupal form array
 */
function media_admin_module_options_permissions_form() {
  // get any cached permissions for the permisisons 
  $permissions = unserialize(variable_get('media_admin_permissions', array()));
  if (! $options = media_admin_extend('media_admin_permissions_settings', $permissions)) {
    drupal_set_message(t('Sorry, there are no modules which have configurable permissions settings.'));
    return;
  }
  
  // build a fieldset per module
  foreach ($options as $module_name => $option) {
    $form[$module_name] = array(
      '#type' => 'fieldset',
      '#title' => $module_name
    );
    
    // create the roll form item
    $append = array(
      '#type' => 'select',
      '#title' => t('Permissions'),
      '#multiple' => true,
    );
    // now we need to itterate through the incoming form and append 
    // the roll setting to each item
    $form[$module_name] = _media_admin_form_perm_append($option, $append, $permissions['module']);
    
    $form[$module_name][] = $options;
  }
}


/**
 * This is a helper function to add in a permissions element 
 * for each of the options that are access
 * @param array $form
 *   the drupal form array that will have items appended to it
 * @param array $append
 *   the form element that will be appended to the form
 * @param array $permissions
 *   permissions saved for this module
 * @return array
 *   drupal form array
 */
function _media_admin_form_perm_append($form, $append, $permissions) {
  foreach ($form as $type => $element) {
    if ($type = '#title') {
      $form[$element .'_perm'] = $append;
      $form[$element .'_perm']['#default_value'] = $permissions[$element .'_perm'];
    }
    elseif (is_array($element)) {
      $form[$type][] = _media_admin_form_perm_append($element, $append, $permissions);
    }
  }
  return $form;
}

/* ***************************************** */
/* Media API Functions                       */
/* ***************************************** */


/**
 * Get all fields that can be enabled on
 * a field type
 * @param string $type
 *   the field type to get items for
 * @param string $function_type
 *   the kind of functionality being looked for
 * @return array
 *   array of full registration objects
 */
function media_get_fields($field_type, $function_type = 'resource') {
  static $data;
  
  // do we have cached version?
  if ($data[$field_type][$function_type]) {
    return $data[$field_type][$function_type];
  }
  
  $data = array();
  // get all the registered modules  
  foreach (media_get_registered_modules() as $id => $registration) {
    // check to see if this registration supports this function type
    if ($registration['kind'] == $function_type) {
      // now look for the fields
      if ($registration['fields']) {
        foreach ($registration['fields'] as $field) {       
          // if this registration supports this field type, add it to the return
          if ($field == $field_type) {
            $data[$field_type][$function_type][$id] = $registration;
          }
        }
      }
    }
  }
  return $data[$field_type][$function_type];
}


/**
 * Build a list of possible registration types
 *
 * @return array
 */
function media_registration_kinds() {
  return array('resource', 'formatter');
}


/* ***************************************** */
/* Media Internal Functions                  */
/* ***************************************** */

/**
 * Parsing function for the registrations to hand back the kinds 
 * of modules registering. Used to select all formatters, resources, etc
 * @param string $kinds
 *   return all the matching registrations of this kind
 * @return array
 */
function media_get_registration_kinds($kind = null) {
  $kinds = array();
  // get the registered modules
  $registrations = media_get_registered_modules();
  // parse the registrations
  foreach ($registrations as $id => $registration) {
    if ($kind) {
      // get the kind that is being looked for
      if ($registration['kind'][$kind]) {
        $kinds[$id] = $registration;
      } 
    }
    else {
       $kinds[$id] = $registration;
    }
  }
  return $kinds;
}


/**
 * Returns a set of formatters which can format the specified 
 * item. If $description is null, all formatters will be returned. If 
 * a set of registered modules can be passed in to narrow the
 * formatter options. 
 * @param string $description
 *   file extension to return
 * @param unknown_type $registrations
 * @return array
 */
function media_registration_item_formatters($description = '*', $registrations = null) {
  $formatters = array();
  // get all the registrations if we don't have any
  if (! $registrations) {
    $registrations = media_get_registered_modules();
  }
  // itterate through each of the registered modules and find the formatters
  foreach ($registrations as  $id => $registration) {
    // look for the formatter, or just take all
    if ((is_array($registration['kind']['formatter']['types']) && in_array($registration['kind']['formatter']['types'], $description))
      || $description == '*' 
      || $registration['kind']['formatter']['types'] == '*') {
      $formatters[$registration['module']] = $id;
    }
  }
  return $formatters;
}


/**
 * parsing function for the registrations to hand back the kinds 
 * of modules registering
 * @param string $type
 *   only hand back data for the specified type
 * @return array
 */
function media_registration_types($type = null) {
  // get the registered modules
  $registrations = media_get_registered_modules();
  // parse the registrations
  foreach ($registrations as $registration) {
    
  } 
}



/**
 * parsing function for the registrations to hand back the kinds 
 * of modules registering
 * @param string $array
 *   name of the element we want to get data from
 * @return array
 */
function media_registration_data($name) {
  $data = array();
  // get the registered modules
  $registrations = media_get_registered_modules();
  // parse the registrations
  foreach ($registrations as $id => $registration) {
    // Do we have this data in this registration
    if ($registration[$name]) { 
      // get the item that was requested
      $data[$registration['module']] = array(
        $id => array(
          $name => $registration[$name], 
          'description' => $registration['description']
        )
      );
    }
  }
  return $data;
}


/**
 * Fetches all resources registered in $resources 
 *
 * @param array $resources
 * @param string $node_type
 * @param field $field
 * @param int $uid
 * @return array
 */
function media_get_resources($resources, $node_type, $field, $uid) {
  // get all the registrations that define the resources
  $registrations = media_get_registered_modules($resources);
  foreach ($registrations as $id => $registration) {
    // get the callback function
    $function = $registration['callbacks']['resource'];
    if (function_exists($function)) {
      // get the results of the callback function
      $item = $function($node_type, $field, $uid);
      $tab_name = key($item);
      // add tabs under the tab name
      $items[$tab_name][key($item[$tab_name])] = $item[$tab_name][key($item[$tab_name])];
      // add the id of the registration on to the form so we can pick it back out later
      $items[$tab_name][key($item[$tab_name])]['resource_id'] = $id;
    }
  }
  return $items;
}


/**
 * Get a list of fields for the requested node type
 *
 * @param string $type
 *   drupal node type
 * @param string $function
 *   one of resource, formatter
 * @return array
 *   array of field names
 */
function media_active_fields_for_node_type($type, $function = 'resource') {  
  $items = variable_get('media_'. $type .'_'. $function, array());
  $data = array(); 
  foreach ($items as $id => $item) {
    // we need to split the $id into $field_name and $media registration id
    $item = explode('--', $id);
    $data[$item[0]][] = $item[1];    
  }
  return $data;
}


/**
 * Sanitize the incoming name to be used for a html #id
 *
 * @param string $drawer_name
 * @return string
 */
function media_create_drawer_id($drawer_name) {
  return str_replace(array(' ', "'", '"', "%", "<", ">"), '', $drawer_name);  
}

/* *************************************************** */
/* Media forms                                         */
/* *************************************************** */

/**
 * Display files in a form element. Default for other modules
 * to make use of.
 * @param array $files
 *   array of (uri => uri, filename => filename, meta => array(key => value))
 * @param string $title
 *   option title argument
 * @return string
 */
function media_display_user_files_form($files, $title = null) {
  // pase files into options array
  $options = array();
  foreach ($files as $file) {
    $options[$file['uri']] = $file['filename'];
  }
  // parse files into form elemet
  $form['media_files'] = array( 
    '#type' => 'select',
    '#options' => $options,
    '#title' => $title ? $title : '',
    '#size' => 10,
  );
  return $form;
}


/**
 * wrapper to build the media tabs
 * @TODO make this a cleaner form function that uses a theme function
 * @param array $forms
 *   array of forms to be tabbed
 * @return array
 */
function media_tabs_form($forms) {
  // @TODO this should not depend on the tabs module
  if (module_exists('tabs')) {
    // load our css
    drupal_add_css(drupal_get_path('module', 'media') .'/media.css');
    // load our js
    drupal_add_js(drupal_get_path('module', 'media') .'/media.js');
    
    $form = array();
    // build the activator for the media browser 
    $form['media_browser_activate'] = array(
      '#type' => 'markup',
      '#value' => '<div class="media browser activation">'. t('Add files') .'</div>',  
    );
    $form['media_tabs'] = array(
      '#type' => 'tabset',
      '#attributes' => array('class' => 'media browser clearfix'),
    );    
    foreach ($forms as $tab_name => $form_data) {
      $form['media_tabs']['tab_'. $tab_name] = array(
        '#type' => 'tabpage',
        '#title' => $tab_name,
        'content' => $form_data,
        '#suffix' => '<br class="clear" />',
      );
    }
  }
  else {
    $form = theme('media_no_tab_display', $forms);
  }
  return $form;
}


/* ***************************************** */
/* Media Hook Implementations                */
/* ***************************************** */


/**
 * Implementation of hook_media_register
 * @return array
 *
 */
function media_media_register() {
  $registration = array( 
    'media_user_files' => array(
      // human readable name
      'name' => t('User files'),
      'uri' => 'file',
      'kind' => 'resource',
      'types' => '*',
      'description' => t('Format Drupal uploaded files'),
      'callbacks' => array( 
        'resource' => 'media_display_user_files',
       ),      
       // human readable description
      'description' => t('Displays all of current user\'s files'),
      'fields' => array('attachments', 'filefield'),
    )
  );
  return $registration;
}
   

/**
 * Implementation of hook_media_user_files_select
 *
 * @param string $node_type
 * @param string $field
 * @param int $uid
 */
function media_display_user_files($node_type, $field, $uid) {
  $files = array();
  $results = db_query('SELECT filepath, filename FROM {files} WHERE uid = %d', $uid);
  while ($file = db_fetch_array($results)) {
    $files[] = array(
      'uri' => $file['filepath'],
      'filename' => $file['filename'],
      'meta' => '',
    );
  }
  $return = array( 
    t('My files') => array(
      t('Local') => media_display_user_files_form($files, t('Your files')),     
    )
  );
  return $return;
}
